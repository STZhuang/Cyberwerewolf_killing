## D18 · 安全边界与渗透测试清单

### 1. 目标

明确系统的**核心安全边界**，并提供一份可执行的**渗透测试清单**。该清单旨在系统性地识别和评估潜在的安全风险，覆盖身份认证、权限控制、数据注入、WebSocket 安全和抗攻击能力等方面，并为每个风险点提供修复和验证策略。

### 2. 核心安全原则

*   **纵深防御 (Defense in Depth)**: 不依赖任何单一的安全措施。在网络、应用、数据等多个层面都设置防护。
*   **最小权限原则 (Principle of Least Privilege)**: 每个用户或服务只应被授予其完成任务所必需的最小权限。
*   **默认安全 (Secure by Default)**: 系统默认配置应是安全的，需要用户或管理员主动操作才能放宽限制。
*   **输入验证，输出编码**: 永远不要相信用户的输入。对所有输入进行严格验证，对所有输出到前端的内容进行适当的编码（如 HTML 转义）。

### 3. 渗透测试清单

这张清单应作为安全团队或开发人员进行安全自查和第三方渗透测试的依据。

| 类别 (Category) | 威胁 (Threat) | 攻击向量 (Vector) / 测试方法 | 缓解与修复策略 |
| :--- | :--- | :--- | :--- |
| **身份认证 (Auth)** | **JWT 伪造/破解** | - 尝试使用 `alg: "none"` 的 JWT。<br>- 尝试对弱密钥 (`JWT_SECRET`) 进行暴力破解。 | - **强制使用强签名算法 (HS256/RS256)**。<br>- **使用长且高熵的密钥**，并定期轮换。 |
| | **会话劫持** | - 在不安全的网络中嗅探 JWT。<br>- 通过 XSS 窃取存储在 `localStorage` 中的 JWT。 | - **全站强制 HTTPS**。<br>- **使用 `HttpOnly`、`Secure` 的 Cookie 存储 JWT**，防止 JS 访问。 |
| | **凭证重放** | - 截获一个有效的 JWT，并在其过期后尝试重用。 | - **设置合理的、较短的 JWT 过期时间**（如 15 分钟），并配合 Refresh Token 机制。 |
| **权限控制 (Access Control)** | **越权访问 (IDOR)** | - 尝试修改 API 请求中的 `roomId` 或 `userId`，访问不属于自己的资源。<br>- 尝试以普通玩家身份调用房主或管理员才能访问的 API。 | - **在每个 API 的业务逻辑中，都必须校验当前用户是否有权操作目标资源**。绝不能仅依赖前端的 UI 限制。 |
| | **游戏逻辑越权** | - 在非投票阶段调用投票接口。<br>- 尝试使用不属于自己角色的技能。<br>- 观战者尝试发言或投票。 | - **服务端对每一次游戏行动都进行严格的阶段、角色和权限校验**（参见 D07）。 |
| **数据注入 (Injection)** | **SQL / NoSQL 注入** | - 在输入字段（如用户名、搜索词）中尝试输入 SQL/NoSQL 查询语句。 | - **使用参数化查询 (Parameterized Queries) 或 ORM**，严禁拼接字符串构造 SQL。 |
| | **跨站脚本 (XSS)** | - 在聊天、用户名等处输入 `<script>alert(1)</script>` 等脚本。<br>- 检查返回的系统公告是否对用户输入做了转义。 | - **对所有输出到 HTML 的内容进行上下文感知的编码**（如使用 React/Vue 的默认数据绑定）。<br>- **实施严格的内容安全策略 (CSP)**。 |
| **WebSocket 安全** | **跨站 WebSocket 劫持 (CSWSH)** | - 构造一个恶意网页，尝试从该网页连接到应用的 WS 端点。 | - **在 WS 握手时，严格校验 `Origin` 请求头**，只允许来自白名单域名的连接。 |
| | **拒绝服务 (DoS)** | - 快速、大量地建立 WS 连接，耗尽服务器资源。<br>- 连接后发送大量高计算消耗的消息。 | - **基于 IP/用户 ID 进行连接数和消息频率限制**。<br>- 对消息大小和复杂度进行限制。 |
| **业务逻辑安全** | **动作重放攻击** | - 截获一个合法的投票请求，并重复发送多次以刷票。 | - **要求所有修改状态的请求都携带一次性的 `reqId`**，服务端进行幂等性处理（参见 D04）。 |
| | **信息泄露** | - 在游戏结束前，尝试通过回放或观战 API 获取未公开的身份信息。 | - **API 必须严格遵守信息隔离原则**，只有在 `game.status` 为 `CLOSED` 时才返回完整信息。 |
| | **计时器攻击** | - 尝试通过伪造请求来提前结束或无限延长某个游戏阶段。 | - **计时器的控制权必须完全在服务端**，客户端只能接收计时器事件（参见 D06）。 |

### 4. 安全开发生命周期 (SDL)

*   **设计阶段**: 进行威胁建模，识别潜在风险点。
*   **开发阶段**: 遵守安全编码规范，进行代码静态分析 (SAST)。
*   **测试阶段**: 执行本清单中的渗透测试，使用动态分析工具 (DAST) 扫描应用。
*   **发布阶段**: 定期进行第三方安全审计和漏洞扫描。

### 5. 验收标准

*   **清单通过率**: 在每次大版本发布前，安全团队或指定的开发人员必须完整地过一遍此清单，所有高危和中危项都必须被修复。
*   **漏洞修复闭环**: 所有发现的安全漏洞都必须被记录在案，并追踪其修复、验证和关闭的全过程。
*   **回归测试**: 确保对安全问题的修复没有引入新的漏洞或破坏现有功能。
*   **无已知高危漏洞**: 应用在上线时，不得存在任何已知的、未修复的高危（如 CVSS > 7.0）漏洞。