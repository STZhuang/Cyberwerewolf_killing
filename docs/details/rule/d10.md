## D10 · 观战与回放 UX

### 1. 目标

为**观战者 (Spectator)** 和**回放用户 (Replay User)** 提供流畅、信息完整且无作弊风险的用户体验。本规范定义了观战的权限、延迟和弹幕系统，以及回放的时间轴、关键节点和交互控件。

### 2. 观战 (Spectating)

观战模式允许非玩家用户实时观看游戏进程。

#### 2.1 权限与信息隔离

*   **核心原则**: 观战者看到的**信息集**，必须是所有**存活玩家公共信息**的子集。
*   **可见内容**:
    *   公共聊天频道的内容。
    *   所有系统公告（阶段变更、死亡信息等）。
    *   玩家的公开行动（如投票给谁）。
    *   白天阶段的玩家状态（谁存活、谁死亡）。
*   **不可见内容**:
    *   任何人的身份牌。
    *   狼人夜间的队内聊天。
    *   GM 与玩家的私密通知（如预言家的查验结果）。
    *   夜间谁对谁使用了技能。

#### 2.2 延迟 (Ghosting Prevention)

*   **幽灵视角 (Ghosting)**: 指观战者通过场外渠道（如语音通话）向场内玩家泄露其通过观战获得的信息。
*   **防范措施**: 所有推送给观战者的事件流，都必须加入一个**服务器端延迟**。
    *   **普通对局**: 默认延迟 3-5 秒。
    *   **竞技模式/比赛**: 延迟可配置为更高，例如 30 秒，或甚至**整个阶段结束后**才推送该阶段的所有事件。

#### 2.3 弹幕 (Danmaku)

*   **独立通道**: 观战者可以发送弹幕。弹幕在一个独立的、仅对其他观战者可见的通道 (`spectator_chat`) 中广播。
*   **隔离**: 弹幕消息**绝不能**出现在游戏内玩家的聊天窗口中。
*   **UI**: 玩家可以自由选择开启或关闭弹幕的显示。

### 3. 回放 (Replaying)

回放功能允许用户在游戏结束后，复盘整个对局过程。

#### 3.1 数据源与时间轴

*   **数据源**: 回放的数据完全来源于已归档的**事件流** (`events` 表)。通过 `GET /games/{id}/events` 拉取。
*   **时间轴**: 回放的核心是**事件索引 (`idx`)**。UI 上的时间轴滑块，其值域就是从 `0` 到该局游戏的总事件数。拖动滑块即是改变当前的 `cursorIdx`。

#### 3.2 交互控件与 UI

回放界面应包含以下核心控件：

```
+-------------------------------------------------------------------+
| Replay Controls                                                   |
|                                                                   |
|  [< Prev] [Play/Pause] [Next >]  Speed: [1x] [2x] [4x]             |
|                                                                   |
|  o----------o-------------o----o----------------------o----------o |
|  ^          ^             ^    ^                      ^          ^ |
| idx=0      Night 1      Vote 1 Day 2                 Kill 3     End
| (Start)    (Keyframe)                                (Keyframe)   |
+-------------------------------------------------------------------+
```

*   **播放控件**: 播放/暂停、下一事件、上一事件。
*   **播放速度**: 支持 1x, 2x, 4x 等倍速播放。
*   **时间轴滑块**:
    *   允许用户自由拖拽到任意一个 `idx`。
    *   当拖拽时，UI 会根据 `target_idx` 重建当时的游戏状态（`reconstruct_state(target_idx)`），并展示当时的玩家存活情况、聊天记录切片等。
*   **关键节点 (Keyframes)**: 为了方便用户快速跳转，时间轴上应明确标记出**关键事件**，例如：
    *   `RolesAssigned` (角色分配)
    *   `PhaseChanged` (阶段变更)
    *   `PlayerDied` (玩家死亡)
    *   `VoteResult` (投票结果)
    *   `GameEnded` (游戏结束)

#### 3.3 性能优化

*   **数据加载**: 对于超长对局（例如 >5000 个事件），前端不应一次性加载所有事件。应采用**分段窗口化**策略，按需从后端拉取。
*   **状态重建**: 状态重建 (`reconstruct_state`) 应在前端高效执行。避免在每次 `idx` 变化时都从头计算，可以利用上一个状态进行增量更新。
*   **内存控制**: 保证在回放包含 10,000 个事件的对局时，浏览器的内存占用峰值在可控范围内（例如 < 200MB）。

### 4. 验收标准

*   **信息安全**: 随机抽查 10 局对局的观战模式，用工具检查 WebSocket 流量，确认没有任何非公开信息泄露给观战者。
*   **回放一致性**: 随机选择 10 局已结束的游戏进行回放。在回放的任意时间点暂停，其显示的 UI 状态（玩家存活、聊天记录）必须与通过事件流逐步推导出的状态完全一致。
*   **性能**: 在回放包含 10,000 个事件的对局时，拖动时间轴滑块的响应应是平滑的（60fps），无明显卡顿。