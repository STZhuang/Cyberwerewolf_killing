## D07 · 身份与角色结算引擎

### 1. 目标

定义游戏中所有**角色技能的结算规则和执行顺序**，确保结算过程是**完全确定性、可重放且易于测试的**。本规范覆盖了标准版狼人杀的主要角色（狼、神、民）及其扩展（如猎人、白痴等），并为未来的新角色设计提供了框架。

### 2. 核心原则：确定性结算

为了保证可重放性，所有可能产生歧义或随机性的结算，都必须由一个**确定性的规则引擎**来处理。随机性只能来源于游戏开局时生成的唯一 `seed`。

### 3. 夜间结算顺序 (Night Phase)

夜间行动的结算顺序至关重要，直接决定了玩家的生死。推荐采用以下顺序，该顺序旨在最小化逻辑冲突：

1.  **守卫行动 (`Guard`)**: 守卫选择当晚要守护的目标。
    *   *规则*: 守卫不能连续两晚守护同一个人。此决策最先发生。
2.  **狼人行动 (`Werewolf`)**: 狼人团队通过队内私聊协商，最终由一名狼人提交当晚要击杀的目标。
    *   *规则*: 如果狼人超时未统一意见，则视为“空刀”，当晚无人被击杀。
3.  **预言家行动 (`Seer`)**: 预言家选择一名玩家进行查验，以获知其阵营（好人/狼人）。
    *   *规则*: 查验结果将通过 GM 私信发送给预言家。
4.  **女巫行动 (`Witch`)**: 女巫是夜间结算最复杂的环节，她拥有解药和毒药。
    *   **4a. 解药判定**: GM 首先告诉女巫当晚被狼人击杀的是谁。女巫可以选择是否使用**解药**救活该玩家。
        *   *规则*: 解药只有一瓶，整局游戏只能使用一次。女巫无法自救（可配置）。
    *   **4b. 毒药判定**: 无论是否使用了解药，女巫都可以选择使用**毒药**杀死一名玩家。
        *   *规则*: 毒药也只有一瓶，且不能和解药在同一晚对同一名玩家使用。

### 4. 黎明结算 (Dawn Phase)

在所有夜间行动提交后，服务器进入黎明结算阶段，计算最终的死亡结果。

*   **死亡计算**:
    1.  获取狼人的目标 `kill_target` 和女巫的毒药目标 `poison_target`。
    2.  检查守卫的守护目标 `guard_target`。如果 `kill_target == guard_target`，则狼人的击杀**无效**。
    3.  检查女巫是否对 `kill_target` 使用了解药。如果使用，则狼人的击杀**无效**。
    4.  最终的死者集合是 `{被成功击杀者} U {被毒杀者}`。
*   **公告**: 服务器向所有玩家广播死亡玩家的席位号。**默认不公开死者的身份**，除非是特殊角色（如猎人）的技能触发。

### 5. 白天结算 (Day Phase)

1.  **投票结算**:
    *   统计所有票数。如果一名玩家获得最多票数，则该玩家被放逐。
    *   **平票处理**: 如果出现平票，则进入“平票发言”阶段，平票者再进行一轮发言，随后再次投票。如果再次平票，则当轮**无人被放逐**（此为可配置规则，也可配置为随机放逐）。
2.  **特殊角色结算**:
    *   **猎人 (`Hunter`)**: 如果猎人在**被放逐**或**夜间被杀**时，他可以发动技能，选择一名玩家一同出局（开枪）。
        *   *规则*: 猎人被女巫毒杀时不能开枪。
    *   **白痴 (`Idiot`)**: 如果白痴在白天被投票放逐，他会翻开自己的身份牌，免于死亡，但会失去投票权。

### 6. 规则参数化 (Game Configuration)

为了增加灵活性，许多角色规则应是可配置的。

```json
// Game.config.rules
{
  "witch": { "heal_limit": 1, "poison_limit": 1, "can_self_heal": false, "reveal_on_use": false },
  "guard": { "no_consecutive_self": true, "no_consecutive_target": true },
  "hunter": { "shoot_on_execute": true, "shoot_on_kill": true, "shoot_on_poison": false },
  "idiot": { "reveal_on_vote_out": true, "loses_vote_on_reveal": true },
  "vote": { "on_tie": "revote" } // "revote" | "no_exile" | "random_exile"
}
```

### 7. 单元测试基线

结算引擎是最需要进行详尽测试的模块。测试用例必须覆盖所有已知的边界情况。

*   **核心场景**: 守卫成功守护、女巫救人、女巫毒人、狼人空刀。
*   **复合场景**:
    *   守卫守护的目标同时被狼人刀和女巫毒。
    *   女巫救了被刀的人，又毒了另一个人。
    *   狼人自刀，女巫是否能看到并选择救或不救。
*   **特殊角色**: 猎人被放逐/被刀/被毒时的开枪条件，白痴被放逐的翻牌逻辑。
*   **投票**: 正常投票、弃票、平票（复投/无人出局/随机）的所有情况。
*   **确定性**: 使用固定的游戏 `seed` 和固定的玩家行动序列，断言最终的事件流和存活玩家列表完全一致。

### 8. 验收标准

*   **代码覆盖率**: 结算引擎模块的单元测试覆盖率必须达到 95% 以上。
*   **边界用例通过率**: 所有已定义的边界测试用例必须 100% 通过。
*   **可追溯性**: 任何一次结算（如玩家死亡），都必须能在事件流中找到清晰的因果链（例如，`NightAction(kill)` -> `PlayerDied(cause='werewolf')`）。