## D06 · 阶段计时与超时策略

### 1. 目标

为游戏中的各个阶段（发言、投票、夜间行动等）提供一个**可靠、精确、可恢复**的计时器机制。同时，定义各阶段的**超时默认行为 (Timeout Policy)**，确保游戏在玩家无响应时也能自动推进。所有计时器事件都必须纳入事件流，以支持精确的回放和审计。

### 2. 阶段与默认时长

游戏时长是可配置的，以下为一套推荐的默认值：

| 阶段 (`Phase`) | 默认时长 (秒) | 描述                               |
| -------------- | ------------- | ---------------------------------- |
| `Night`        | 45            | 夜间行动阶段                       |
| `Dawn`         | 5             | 黎明，公布夜间结果的过渡阶段       |
| `DayTalk`      | 120           | 白天自由发言阶段                   |
| `Vote`         | 30            | 投票放逐阶段                       |
| `Trial`        | 45            | 被投票玩家的遗言/辩护阶段          |
| `Result`       | 5             | 公布投票/结算结果的过渡阶段        |

### 3. 计时器相关事件

计时器的启动、变更和结束都必须作为事件记录下来。

*   `TimerStarted { phase: string, deadline_ts: number }`: 标志着一个新阶段的计时器开始。`deadline_ts` 是该阶段结束的 UTC 毫秒时间戳。
*   `TimerExtended { reason: string, new_deadline_ts: number }`: 当计时器被延长时记录。例如，由 GM 手动延长或特定游戏事件触发。
*   `TimerEnded { phase: string, timed_out: boolean }`: 标志着一个阶段的计时器结束。`timed_out` 指示是正常结束还是超时导致。

### 4. 超时默认行为 (Timeout Policy)

当玩家在规定时间内未做出操作，系统将自动为其执行默认操作。

| 阶段      | 超时行为                                                     | 对应生成的事件                                               |
| --------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `DayTalk` | 视为**放弃发言**。                                           | 不产生 `Speak` 事件，或产生 `Speak { content: null, timed_out: true }` 用于统计。 |
| `Vote`    | 视为**弃票**。                                               | `Vote { target_seat: null, timed_out: true }`                |
| `Trial`   | 视为**放弃遗言/辩护**。                                      | 同 `DayTalk`。                                               |
| `Night`   | **按角色决定**：<br/>- **狼人**: 若未统一意见，则当晚**空刀**。<br/>- **预言家**: 随机选择一名未查验过的存活玩家进行查验。<br/>- **女巫**: 不使用任何药剂。<br/>- **守卫**: 随机选择一名除自己外的存活玩家进行守护（且不能是上一晚的目标）。 | `NightAction { action: 'kill', target_seat: null, timed_out: true }` 等。 |

### 5. 技术实现方案

为保证计时的精确性和可恢复性，推荐采用基于**延迟任务队列**的方案。

1.  **启动计时器**: 当 `PhaseChanged` 事件发生时，计算出 `deadline_ts`，并向一个延迟任务队列（如 Redis ZSET 或 RabbitMQ a-delayed-message-exchange）中添加一个任务。任务的执行时间就是 `deadline_ts`。
2.  **任务执行**: 当到达执行时间，一个 Worker 会消费该任务。Worker 的职责是检查当前游戏状态，如果阶段仍未改变，则执行超时策略，生成相应的默认动作事件和 `TimerEnded` 事件。
3.  **幂等性**: Worker 的处理逻辑必须是幂等的。在执行超时动作前，应再次确认游戏阶段是否匹配，防止因网络延迟或消息重复导致错误执行。
4.  **服务重启恢复**: 如果服务器在计时器运行时重启，它可以在启动时扫描 `events` 表，找到最后一个 `TimerStarted` 事件。通过 `deadline_ts` 和当前时间，可以重建计时器的剩余时间，并重新向延迟队列提交任务。
5.  **暂停与扩展**:
    *   **扩展**: GM 或房主可以通过 API 延长计时。这会更新 Redis 中的 `deadline` 并向延迟队列发送一个更新后的任务。
    *   **暂停**: 当游戏需要暂停（例如，等待断线玩家重连），可以记录一个 `TimerPaused` 事件，并从延迟队列中移除任务。恢复时再重新计算 `deadline` 并添加任务。

### 6. 验收标准

*   **精确性**: 在 1000 局并发游戏测试中，定时器的实际触发时间与预设 `deadline` 的误差 p99 应小于 500ms。
*   **恢复能力**: 在计时器运行期间，手动重启游戏服务器。验证服务器重启后，所有计时器都能在 5 秒内恢复，并且最终的超时时间点与重启前相比误差不超过 1 秒。
*   **超时策略**: 单元测试应覆盖所有角色和阶段的超时行为，验证生成的默认事件符合规范。
*   **回放一致性**: 在回放中，计时器的进度条应与 `TimerStarted` 和 `TimerEnded` 事件的时间戳完全匹配。