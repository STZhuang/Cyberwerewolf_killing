## D12 · 负载与成本基准

### 1. 目标

建立一套标准化的、可复现的**性能与成本基准测试流程**。通过模拟高并发场景，量化系统的核心性能指标（如广播延迟、Agent 响应时长），并估算和监控 LLM Agent 的 Token 消耗与运营成本，为容量规划和成本优化提供数据支持。

### 2. 核心监控指标

#### 2.1 性能指标

*   **WebSocket 广播延迟**:
    *   `ws_broadcast_latency_p50/p95/p99_ms`: 从服务器发出事件到客户端收到的端到端延迟的百分位统计。这是衡量实时性的关键。
    *   `ws_connection_count`: 当前活跃的 WebSocket 连接总数。
    *   `ws_reconnect_success_rate`: 断线重连成功率。
*   **Agent 服务**:
    *   `agent_decision_latency_p50/p95_ms`: 从 Agent 收到请求到其返回决策（工具调用）的总时长。
    *   `agent_concurrent_requests`: Agent 服务的并发处理数。
    *   `agent_tool_call_legality_rate`: Agent 调用工具的合法率（即符合游戏规则的比例）。
    *   `agent_llm_api_failure_rate`: 底层 LLM API 的请求失败率。

#### 2.2 成本指标

*   **Token 消耗**:
    *   `tokens_used_total (prompt|completion|total)`: 按 Prompt Token 和 Completion Token 分别统计的总消耗量，可按模型、Agent 角色、房间等维度聚合。
*   **成本估算**:
    *   `cost_per_game_usd`: 每局完整游戏的平均成本（美元）。
    *   `cost_per_agent_per_hour_usd`: 每个 Agent 每小时的平均成本。

### 3. 压测脚本

压测脚本应位于 `/tests/load/` 目录下，并能通过简单的命令在本地和预发环境中执行。

*   **`ws_broadcast_stress.py`**:
    *   **功能**: 模拟大规模 WebSocket 连接，测试广播性能。
    *   **流程**:
        1.  启动 N 个进程/协程。
        2.  每个进程创建 M 个 WebSocket 客户端，连接到同一个或多个房间。
        3.  一个专门的“驱动”客户端向服务器发送一个动作（如发言）。
        4.  所有“监听”客户端记录收到该广播事件的时间戳。
        5.  计算时间差，汇总并输出延迟的分布（P50, P95, P99）。
    *   **示例**: `python tests/load/ws_broadcast_stress.py --rooms 100 --clients_per_room 9 --duration 300s`

*   **`agent_simulation.py`**:
    *   **功能**: 模拟大量 Agent 并发决策，测试 Agent 服务和 LLM API 的负载。
    *   **流程**:
        1.  准备一个包含多种游戏场景（不同阶段、不同上下文）的数据集。
        2.  启动 N 个并发客户端。
        3.  每个客户端随机从数据集中抽取一个场景，向 Agent 服务发起决策请求。
        4.  **可选**: 为了降低真实 LLM API 的成本，可以在压测时使用一个“Stub LLM”，它会立即返回一个预设的、合法的工具调用响应。这能将压力集中在 Agent 服务本身。
        5.  记录响应时长、成功率、工具合法率等指标。

### 4. 仪表板 (Dashboard)

*   **技术栈**: 使用 **Prometheus** 收集指标，**Grafana** 进行可视化。
*   **核心面板**:
    *   **WebSocket 概览**: 实时连接数、广播延迟热力图、消息吞吐量 (in/out)。
    *   **Agent 性能**: Agent 决策延迟 P95、并发请求数、工具调用合法率、LLM API 错误率。
    *   **成本监控**:
        *   按模型分类的累计 Token 消耗（条形图）。
        *   每局游戏的平均成本趋势（折线图）。
        *   成本最高的 Top 10 Agent 角色或房间。

### 5. 性能与成本目标线 (v0)

*   **WS 广播**: 在 5000 房间、每房 9 人的负载下，p95 广播延迟 **≤ 200ms**。
*   **Agent 合法率**: Agent 的工具调用合法率 **≥ 99.5%**，越权（泄露身份等）发言率 **< 0.1%**。
*   **成本预算**: 在使用 `gpt-4o-mini` 或同级别模型时，一局完整的 9 人游戏（含 4 个 Agent）的平均成本应控制在 **≤ $0.25**。

### 6. 验收标准

*   **可复现性**: 压测脚本能够在本地和预发环境中稳定运行，并产出与预期格式一致的性能报告。
*   **仪表板可用性**: Grafana 仪表板能够正确、清晰地展示所有核心性能与成本指标，并能按时间、模型等维度进行筛选。
*   **达标验证**: 在预发环境中执行一次完整的基准测试，验证各项指标是否达到或优于设定的目标线。