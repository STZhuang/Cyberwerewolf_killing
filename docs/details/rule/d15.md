## D15 · 部署与密钥管理

### 1. 目标

规范应用在**容器化环境（以 Kubernetes 为例）中的部署、配置和密钥管理流程**。确保发布过程安全、可靠，支持滚动升级与快速回滚，并对敏感信息进行严格的权限控制。

### 2. 部署架构

#### 2.1 服务组件

*   **核心服务**: `api-server`, `ws-gateway`, `agent-runtime` (可部署为多个独立的 Agent 服务)。
*   **基础设施**: `PostgreSQL` (数据库), `Redis` (缓存), `NATS` (消息总线)。
*   **可观测性**: `Prometheus` (指标), `Grafana` (看板), `OpenTelemetry Collector` (链路), `Loki` (日志)。

#### 2.2 部署环境

*   **本地开发**: `docker-compose`，一键拉起所有服务。
*   **预发布 (Staging)**: 与生产环境一致的 K8s 集群，用于发布前的最终验证。
*   **生产 (Production)**: 高可用的 K8s 集群。

### 3. 配置与密钥管理

**核心原则**: 代码与配置分离，配置与密钥分离。

*   **配置 (ConfigMaps)**:
    *   非敏感的配置项，如 `MAX_PLAYERS`, `PHASE_DURATIONS` 等，应存储在 K8s 的 `ConfigMap` 中。
    *   通过 `envFrom` 或文件挂载的方式注入到 Pod 中。
*   **密钥 (Secrets)**:
    *   **敏感信息**: `JWT_SECRET`, `DB_URL`, `REDIS_URL`, `AGNO_*_API_KEY` 等，**必须**存储在 K8s 的 `Secrets` 对象中。
    *   **安全存储**: 在生产环境中，K8s Secrets 应与外部密钥管理系统（如 **HashiCorp Vault** 或云厂商的 **KMS**）集成，实现“静态加密 (Encryption at Rest)”。
    *   **注入方式**: 推荐使用 **CSI Secret Store** 驱动，将外部 KMS 中的密钥直接挂载为 Pod 内的文件，避免密钥出现在 K8s 的 etcd 中。
    *   **权限控制**: 使用 RBAC (Role-Based Access Control) 严格限制对 Secrets 对象的访问权限。

**示例 Helm `values.yaml`**:
```yaml
# values.yaml for api-server
replicaCount: 3

image:
  repository: my-registry/api-server
  tag: v1.2.3

config:
  logLevel: "info"
  maxRooms: 5000

# Secrets will be mounted from an external source via CSI
secrets:
  jwtSecretName: "cyber-werewolves-jwt-secret"
  databaseUrlSecretName: "cyber-werewolves-db-url"

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 75
```

### 4. 发布与回滚策略

*   **CI/CD**:
    1.  代码合并到 `main` 分支后，触发 CI 流水线（编译、单元测试、代码扫描）。
    2.  构建 Docker 镜像并推送到镜像仓库。
    3.  触发 CD 流水线，使用 **Helm** 将新版本部署到 `staging` 环境。
    4.  在 `staging` 环境运行自动化 E2E 测试和负载测试。
    5.  测试通过后，需要**人工审批**才能部署到 `production` 环境。
*   **滚动更新 (Rolling Update)**:
    *   采用 K8s 默认的滚动更新策略，保证服务不中断。
    *   配置 `strategy.rollingUpdate`: `maxSurge=25%` (最多允许超出期望副本数的 25%), `maxUnavailable=0` (在更新过程中，不允许可用副本数低于期望值)。
*   **蓝绿/金丝雀发布 (Advanced)**:
    *   对于重大更新，可采用金丝雀发布。先将 5% 的流量（例如，通过服务网格如 Istio 按 `roomId` 哈希切分）导入到新版本。
    *   观察新版本的性能和业务指标。如果一切正常，逐步增加流量比例。
    *   一旦发现问题，立即将所有流量切回旧版本。
*   **回滚**:
    *   使用 `helm rollback <release-name> <revision>` 命令可以快速回滚到上一个稳定版本。

### 5. 数据备份与恢复

*   **数据库**:
    *   使用 `pgbackrest` 或云厂商提供的服务，配置**时间点恢复 (PITR)**。
    *   每日进行一次全量快照，并持续归档 WAL 日志。
*   **事件日志**:
    *   除了存储在数据库中，`events` 表的数据应每日定时备份到 **S3 等对象存储**中，并启用版本化和生命周期策略，作为最终的灾难恢复保障。

### 6. 验收标准

*   **部署自动化**: 从代码提交到部署至 `staging` 环境的整个过程应是完全自动化的。
*   **密钥安全**: 运行安全扫描工具，确认在任何 Pod 的环境变量或 `ConfigMap` 中都找不到明文密钥。
*   **故障演练**:
    *   **回滚演练**: 成功执行一次 `helm rollback`，验证应用可以无误地回退到前一个版本。
    *   **恢复演练**: 模拟数据库故障，验证能够从备份中成功恢复一局完整的对局数据。
    *   **密钥轮换演练**: 模拟一次密钥轮换，验证应用在不重启的情况下能够动态加载新密钥并正常工作。