## D01 · LLM 服务提供商与模型选择规范

### 1. 目标

建立一套灵活、可扩展的 LLM 服务管理体系。该体系支持在**全局、房间、席位、Agent 角色**等多个层级上动态指定和切换 LLM 提供商及其配置。核心目标是统一**推理超参、服务限流、成本审计与密钥管理**，为“人机混战”提供稳定、可控的 AI 能力。

### 2. 核心概念

*   **Provider (服务商)**：定义一个具体的 LLM API 服务来源，例如 OpenAI、Google Gemini、Anthropic Claude，或自建的 vLLM/TGI 服务。它封装了 `base_url`, `api_key` 等连接信息。
*   **Preset (预设集)**：在特定 `Provider` 基础上，定义的一组可复用的**推理参数组合**。例如，可以创建一个名为“创意狼人”的 Preset，使用 `gpt-4o-mini` 模型，并设置较高的 `temperature`；或创建一个“严谨预言家”的 Preset，使用 `claude-3-sonnet` 并设置较低的 `temperature`。
*   **Binding (绑定)**：将一个 `Preset` 应用到特定**作用域 (Scope)** 的规则。这是实现动态配置的核心。例如，可以将“严谨预言家”的 Preset 绑定到所有 `agent_role=Seer` 的席位上。

### 3. 数据模型 (Pydantic Schema)

```python
# 位于: /packages/sdk-py/models/llm_config.py

from pydantic import BaseModel, AnyUrl, Field, SecretStr
from typing import Literal, Optional, Dict

class Provider(BaseModel):
    """定义一个 LLM 服务提供商。"""
    id: str = Field(..., description="服务商唯一标识，如 'prov-openai-official'")
    name: str = Field(..., description="可读名称，如 'OpenAI 官方'")
    type: Literal["openai", "anthropic", "gemini", "openrouter", "vllm", "custom"] = Field(..., description="服务商类型，用于适配不同的 API 协议")
    base_url: AnyUrl = Field(..., description="API 的基础 URL")
    api_key: SecretStr = Field(..., description="API 密钥，将作为密文处理")
    default_model: str = Field(..., description="该服务商下的默认模型 ID")
    headers: Dict[str, str] = Field(default_factory=dict, description="自定义请求头，例如用于特定云服务的认证")
    timeout_s: int = Field(default=60, description="API 请求超时时间（秒）")
    rate_limit_tpm: Optional[int] = Field(default=None, description="每分钟 Token 限流 (TPM)")
    rate_limit_rpm: Optional[int] = Field(default=None, description="每分钟请求数限流 (RPM)")
    enabled: bool = Field(default=True, description="是否启用该服务商")

class Preset(BaseModel):
    """定义一组可复用的模型及推理参数。"""
    id: str = Field(..., description="预设集唯一标识，如 'preset-creative-wolf'")
    provider_id: str = Field(..., description="关联的 Provider ID")
    model_id: str = Field(..., description="要使用的具体模型 ID，如 'gpt-4o-mini'")
    name: str = Field(..., description="可读名称，如 '创意狼人发言风格'")
    temperature: float = Field(default=0.7, ge=0.0, le=2.0, description="温度，控制生成文本的随机性")
    top_p: float = Field(default=1.0, ge=0.0, le=1.0, description="Top-P 采样，控制核心词汇的范围")
    max_tokens: int = Field(default=2048, description="生成的最大 Token 数")
    seed: Optional[int] = Field(default=None, description="随机种子，用于可复现的输出")
    stop: Optional[list[str]] = Field(default=None, description="停止序列")
    modalities: list[Literal["text", "vision", "audio"]] = Field(default=["text"], description="支持的模态")
    tools_allowed: bool = Field(default=True, description="是否允许此预设使用工具")
    vision_max_pixels: int | None = Field(default=None, description="对于视觉模型，允许处理的最大像素数")

class Binding(BaseModel):
    """将预设集绑定到特定作用域。"""
    id: str = Field(..., description="绑定规则的唯一标识")
    scope: Literal["global", "room", "seat", "agent_role"] = Field(..., description="作用域类型")
    scope_key: str = Field(..., description="作用域的键。例如: scope='room' 时, scope_key='room-123'; scope='agent_role' 时, scope_key='Werewolf'")
    preset_id: str = Field(..., description="要应用的 Preset ID")
    priority: int = Field(default=0, description="解析优先级。数字越大，优先级越高，将覆盖低优先级的绑定。例如，'seat' (100) > 'room' (10) > 'global' (0)")
```

### 4. API 契约 (REST Endpoints)

提供对 Provider, Preset, Binding 的增删改查（CRUD）管理，并提供一个核心的解析接口。

```
# --- Provider Management (Admin Only) ---
POST   /admin/providers             # 新增 Provider
GET    /admin/providers             # 列表 (脱敏 api_key)
PATCH  /admin/providers/{id}        # 更新/启用/禁用
DELETE /admin/providers/{id}        # 删除

# --- Preset Management ---
POST   /admin/presets               # 新增模型预设
GET    /admin/presets               # 列表
PATCH  /admin/presets/{id}          # 更新
DELETE /admin/presets/{id}          # 删除

# --- Binding Management ---
POST   /admin/bindings              # 绑定预设到作用域
GET    /admin/bindings?scope=...    # 查询绑定规则
DELETE /admin/bindings/{id}         # 删除

# --- Core Resolution API (Used by Game Service) ---
GET    /resolve-model?roomId=...&seat=...&role=...
# 描述: 根据给定的上下文（房间、席位、角色），解析出最终生效的模型配置。
# 这是 Agent 决策前必须调用的接口。
```

**解析接口返回示例 (`/resolve-model`)**

```json
{
  "provider": {
    "id": "prov-openai",
    "type": "openai",
    "base_url": "https://api.openai.com/v1"
  },
  "model_config": {
    "model_id": "gpt-4o-mini",
    "temperature": 0.6,
    "max_tokens": 1536,
    "tools_allowed": true
  },
  "resolution_trace": [
    {"scope":"global", "scope_key": "*", "preset_id":"p-default", "priority":0},
    {"scope":"agent_role", "scope_key":"Werewolf", "preset_id":"p-wolf-aggressive", "priority":10}
  ]
}
```

### 5. 权限与密钥管理

*   **密钥安全**：`api_key` 必须在后端服务中闭环管理，绝不泄露给前端或客户端。推荐使用云服务商的 KMS 或 HashiCorp Vault 进行加密存储，并通过 Kubernetes Secrets 等机制安全注入到运行时环境。
*   **访问控制**：
    *   `Provider` 的管理权限仅限于**系统管理员**。
    *   `Preset` 和 `Binding` 的管理权限可下放给**运营人员**，以便灵活调整 AI 行为策略。

### 6. 失败与降级策略

*   **自动重试**：当遇到服务商返回 429 (Rate Limit), 500, 503 等可恢复错误时，系统应采取**指数退避**策略进行重试（例如，等待 1s, 2s, 4s），上限为 3 次。
*   **Provider 降级**：若主 `Provider` 连续多次失败，系统应能自动降级到预先配置的**备用 `Preset`**（可能指向另一个更稳定或成本更低的 `Provider`）。
*   **单房间熔断**：若某个房间内的 Agent 连续 N 次决策失败，可对该房间触发熔断，临时切换到全局最稳定的“安全模式 Preset”，避免影响对局。
*   **审计日志**：所有失败、重试、降级和熔断事件都必须记入**审计日志** (`agent_sessions` 或 `events` 表)，以便事后分析。

### 7. 验收标准

*   **功能**：能够在不中断游戏的情况下，通过 API 热更新某个席位的模型配置，并立即生效。
*   **可追溯性**：任何一次 Agent 的决策，其日志中都必须包含 `resolution_trace`，清晰说明为何选用该模型及参数。
*   **性能**：模型配置解析接口 (`/resolve-model`) 必须有高效缓存（如本地或 Redis 缓存），在并发 1000 次请求下，p95 延迟应 ≤ 5ms。