## D02 · 聊天气泡与时间线 UI 规范

### 1. 目标

为游戏前端界面建立一套统一、标准化的**消息渲染与时间线规范**。此规范覆盖所有类型的游戏内信息，包括：玩家发言、投票、夜间行动、系统公告、Agent 的工具调用过程，以及公共/私密聊天流。核心要求是支持**流式输出**、**虚拟滚动**，并能优雅地处理**消息的撤回与更正**。

### 2. 核心组件

*   `TimelineView`: 整个游戏事件的主视图，按事件 `idx` 顺序渲染所有内容。它是一个虚拟滚动容器。
*   `PhaseBanner`: 位于时间线顶部的横幅，清晰地展示当前游戏阶段（如“天黑请闭眼”、“白天发言”）和倒计时。
*   `MessageBubble`: 核心的消息气泡组件，用于展示单条信息。它的外观和内容根据消息类型动态变化。
*   `ActionPanel`: 玩家的交互区域，根据当前阶段显示不同的操作按钮（如“投票”、“使用技能”）。
*   `SystemToast`: 用于显示非阻塞性的短时系统提示，例如“投票已成功提交”。

### 3. 消息类型与视觉呈现

| 消息类型 (`type`) | 子类 (`sub_type`)      | 可见性 (`visibility`) | 核心内容要素                 | 视觉渲染要点                                                 |
| ----------------- | ---------------------- | --------------------- | ---------------------------- | ------------------------------------------------------------ |
| `speak`           | `public`, `team`       | `public` 或 `team`    | 文本内容（支持 Markdown）      | 区分自己与他人（如左右对齐），显示头像、席位号、昵称。         |
| `vote`            | `submit`, `result`     | `public`              | 投票发起者、目标席位、是否弃票 | 投票过程以紧凑行显示，投票结果以卡片形式汇总。               |
| `night_action`    | `submit`, `result`     | `team` 或 `private`   | 行动类型、目标、结果         | 仅对授权角色可见，使用特殊图标或背景色以示区分。             |
| `system`          | `phase`, `timer`, `notice` | `public`              | 标题、说明文本               | 通常以居中、无头像的横幅或卡片形式呈现，用于分割阶段。       |
| `agent_tool`      | `call`, `result`, `error`  | 按上下文决定          | 工具名、参数、返回数据（表格/代码） | 默认折叠，可展开查看详情。提供“复制”按钮。                   |

### 4. `MessageBubble` 组件接口 (TypeScript)

```ts
// 位于: /apps/web/components/Timeline/MessageBubble.tsx

export type Visibility = "public" | "team" | "private" | "system";

export interface MessageBubbleProps {
  // --- 核心标识 ---
  id: string;                      // 唯一 ID，通常对应 event.idx，用于 key 和更新
  correlationId?: string;          // 关联 ID，用于将多个事件（如 call/result）关联到同一UI块
  seat?: number;                   // 发起者席位号 (system 消息可为空)
  authorName: string;              // 发起者昵称
  roleBadge?: "GM" | "Spectator" | string; // 特殊角色徽章

  // --- 可见性与上下文 ---
  visibility: Visibility;
  phase: "Night" | "DayTalk" | "Vote" | "Trial" | "Result";
  timestamp: number;               // 事件发生的时间戳

  // --- 状态与内容 ---
  status?: "pending" | "streaming" | "final" | "error" | "retracted"; // 消息状态
  content: {
    // 主要文本内容，支持流式更新
    text?: string | { chunks: readonly string[] };
    // 结构化内容块，用于富文本展示
    blocks?: Array<
      | { type: "markdown"; content: string }
      | { type: "table"; headers: string[]; rows: string[][] }
      | { type: "image"; src: string; alt?: string }
      | { type: "code"; language: string; code: string }
      | { type: "vote_summary"; votes: { from: number; to: number | null }[] }
    >;
    // 引用或来源，用于 Agent 回答溯源
    citations?: Array<{ label: string; source_id: string }>;
  };

  // --- 交互 ---
  actions?: Array<{ label: string; onClick: () => void }>; // 气泡上的快捷操作
  onRetry?: () => void; // 当 status='error' 时，提供重试回调
}
```

### 5. 交互细节

*   **流式输出**：当 `status="streaming"` 时，气泡右上角显示一个动态的“输入中”光标。`content.text.chunks` 数组会不断追加新内容，UI 实时渲染。当流结束时，`status` 变为 `final`。
*   **消息更正/撤回**：如果后端发送一个具有相同 `id` 但内容更新的事件，UI 应平滑地替换现有气泡的内容。如果事件标记为 `retracted`，UI 应将气泡置灰或显示“消息已撤回”。
*   **私聊/队聊**：
    *   狼人夜间队聊 (`visibility="team"`) 的气泡应有特殊角标（如“狼队”）或背景色。
    *   GM 私信 (`visibility="private"`) 应有明确的“GM”标识和独特的视觉样式（如淡黄色背景）。
*   **虚拟滚动**：为保证长对局的性能，`TimelineView` 必须采用虚拟滚动技术（如 `react-virtual` 或 `vue-virtual-scroller`）。只渲染视口内及少量缓冲区内的消息，确保在 10k+ 消息量下滚动依然流畅。

### 6. 可访问性 (a11y)

*   **键盘导航**：用户应能使用 `Tab` 和方向键在消息和可交互元素之间导航。
*   **屏幕阅读器**：所有消息气泡都应有完整的 `aria-label`，清晰地读出“{席位号}号玩家 {某某} 在 {时间} 说：{内容}”。
*   **颜色对比度**：所有文本和背景的颜色对比度必须满足 WCAG AA 标准 (≥ 4.5:1)。提供高对比度主题。

### 7. 验收标准

*   **一致性**：断线重连后，客户端能根据 `idx` 准确恢复消息序列，无重复、无错序、无丢失。
*   **性能**：在模拟 100 条流式消息并发输入的场景下，页面帧率 (FPS) 保持在 55 以上。在包含 10,000 条消息的对局中，内存占用峰值可控（例如，≤ 300MB，具体取决于媒体资源）。
*   **健壮性**：错误和撤回的消息能被正确、优雅地处理，不破坏 UI 布局。