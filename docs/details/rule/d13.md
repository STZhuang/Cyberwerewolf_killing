## D13 · 日志、审计与隐私

### 1. 目标

建立一套统一的**日志记录、审计追踪与隐私保护**规范。该规范旨在确保所有系统行为都有据可查，敏感操作可被追责，同时严格保护用户隐私，符合数据安全与合规要求。

### 2. 日志分层与分类

不同类型的日志应有不同的格式、存储和生命周期策略。

| 日志类型         | 主要目的             | 格式          | 存储位置         | 留存策略（示例） |
| ---------------- | -------------------- | ------------- | ---------------- | ---------------- |
| **业务事件**     | 游戏逻辑真相、可重放 | `events` 表结构 | PostgreSQL       | **永久**         |
| **访问日志**     | 流量监控、问题排查   | Nginx/JSON    | ELK / Loki       | 热数据 7 天      |
| **应用日志**     | 服务状态、错误调试   | JSON          | ELK / Loki       | 热数据 14 天     |
| **审计日志**     | 安全追责、合规审查   | JSON          | 专用日志服务/S3  | 归档 180+ 天     |
| **LLM 交互日志** | Agent 行为分析、调试 | JSON          | S3 / Agent Trace | 温数据 30 天     |

### 3. 统一日志格式 (JSON)

除业务事件外，所有应用日志和审计日志都应采用结构化的 JSON 格式，以便于机器解析和查询。

**日志条目示例 (`application.log`)**:
```json
{
  "timestamp": "2025-08-13T12:30:05.123Z",
  "level": "ERROR",
  "service": "game-service",
  "trace_id": "trace-uuid-abc-123", // 用于关联全链路日志
  "span_id": "span-uuid-def-456",
  "context": {
    "user_id_hash": "sha256_of_user_id", // 见隐私处理
    "room_id": "r_123",
    "game_id": "g_456"
  },
  "action": "ProcessNightAction",
  "message": "Failed to process night action for player.",
  "details": {
    "seat": 5,
    "error_code": "SKILL_NOT_AVAILABLE",
    "error_details": "Witch has no poison left."
  }
}
```

### 4. 隐私保护与数据脱敏

**核心原则**: 任何时候都应最小化个人身份信息 (PII) 的存储和暴露。

| 数据类型         | 原始数据示例        | 脱敏/处理方式                                                | 备注                                                         |
| ---------------- | ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **用户 ID**      | `user-alice-123`    | 在日志中使用单向哈希值 (`sha256(id)`)。                      | 仅在需要关联用户时，通过查询主数据库进行映射。               |
| **用户名/昵称**  | `Alice`             | **不记录**在日志中。使用 `user_id_hash` 或 `seat` 作为标识。 |                                                              |
| **IP 地址**      | `123.45.67.89`      | 截断或匿名化（如 `123.45.0.0`）。                            | 仅在安全分析（如 DoS 防护）时使用完整 IP，且访问受限。       |
| **聊天内容**     | `“...”`             | **不直接存入应用日志**。仅在 `events` 表中记录，且访问受限。 |                                                              |
| **LLM 上下文/输出** | `“你是狼人...”` | **摘要与指纹化**。仅存储 Token 数量、工具调用等元数据，以及用于调试的、经过关键词掩码的少量文本片段。完整原文不落盘，或仅在用户明确授权的调试会话中临时存储。 | 保护 Agent 策略隐私，也防止泄露游戏状态。                  |

### 5. 审计日志

审计日志记录的是**高权限或高风险**的操作，是安全追责的关键。

*   **需要审计的操作**:
    *   管理员对 LLM Provider/Preset 的增删改。
    *   GM 手动干预游戏（如延长计时、判定胜负）。
    *   内容审核系统执行的撤回、禁言等操作。
    *   用户权限的变更。
    *   对敏感数据（如 `events` 表）的查询或导出。
*   **访问控制**: 审计日志的访问权限必须被严格控制，仅限于安全和合规团队。所有对审计日志的查询本身也必须被记录。

### 6. 数据合规

*   **数据出境**: 如果使用了海外的 LLM 服务商，必须在隐私政策中明确告知用户其数据可能会被传输到境外，并遵守当地的数据保护法规（如 GDPR）。
*   **用户授权**: 用户应有权查看和导出自己的游戏数据，并有权请求删除其账户和相关 PII。

### 7. 验收标准

*   **日志覆盖率**: 系统中所有服务的关键路径（如处理请求、数据库交互、调用外部服务）都必须有结构化的日志输出。
*   **隐私扫描**: 定期使用自动化工具扫描所有日志存储，确保没有明文的 PII（如用户名、IP、密码）被意外记录。
*   **链路追踪**: 随机抽取一个用户请求，验证能够通过 `trace_id` 在日志系统中（如 ELK/Loki）轻松地筛选出从网关到后端服务的完整调用链。
*   **审计可达性**: 模拟一次安全事件（如 GM 误操作），验证能够在审计日志中快速定位到操作人、时间、操作内容等关键信息。